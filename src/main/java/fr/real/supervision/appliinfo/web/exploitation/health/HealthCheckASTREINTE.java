package fr.real.supervision.appliinfo.web.exploitation.health;


import fr.real.supervision.appliinfo.connector.sms.SmsProperties;
import fr.real.supervision.appliinfo.connector.sms.model.OpsGenieErrorResponse;
import kong.unirest.HttpResponse;
import kong.unirest.JsonNode;
import kong.unirest.Unirest;
import org.apache.commons.lang3.StringUtils;
import org.json.JSONObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.actuate.health.Health;
import org.springframework.boot.actuate.health.HealthIndicator;
import org.springframework.stereotype.Component;


@Component("astreinte")
public class HealthCheckASTREINTE implements HealthIndicator {

    private static final Logger LOGGER = LoggerFactory.getLogger(HealthCheckASTREINTE.class);

    @Autowired
    SmsProperties properties;

    @Override
    public Health health() {
        if (!checkAstreinte()) {
            return Health.down().withDetail("Server Astreinte", "Not Available").build();
        }
        return Health.up().withDetail("Server Astreinte", "Available").build();
    }

    private boolean checkAstreinte() {

        boolean result = false;

        try {

            LOGGER.info("Envoi d'une astreinte vide a OpsGenie pour verifier le fonctionnement du service");

            HttpResponse<OpsGenieErrorResponse> response = Unirest.post(properties.getOpsGenieUrl() + "alerts")
                    .header("Authorization", String.format("GenieKey %s", properties.getOpsGenieToken()))
                    .header("Accept", "application/json")
                    .asObject(OpsGenieErrorResponse.class);


            // La reponse doit avoir un statut 400 Bad Request (car la requete avait un body vide), et doit contenir un requestId non null
            if(response.getStatus() == 400 && StringUtils.isNotEmpty(response.getBody().getRequestId())){
                result = true;
            }

        } catch (Exception e) {
            LOGGER.error("la requete au serveur Astreinte a echoue",e);
        }

        return result;
    }



}
